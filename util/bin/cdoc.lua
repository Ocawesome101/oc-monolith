-- basic automated documentation generation for components using their builtin tostring features --
--[[ Copyright (C) 2020 Ocawesome101

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details. ]]

local component = require("component")
local shell = require("shell")
local pager = os.getenv("MANPAGER") or "/bin/less.lua"

local function view(file)
  shell.execute(pager, file)
end

local args, opts = shell.parse(...)

if opts.help or #args < 1 then
  print([[
cdoc copyright (c) 2020 Ocawesome101 under the GNU GPLv3.
Automated component documentation generation using their built-in tostring() functionality. May not work fully in some emulators.

usage:
  cdoc [--<help|verbose>|-v] COMPONENTTYPE

  Outputs a text file consisting of basic documentation for the specified component, if installed.
]])
  return 1
end

local ctype = args[1]

print("Generating documentation for '"..ctype.."'....")
local comp = component[ctype]

local outfile, err = io.open("/tmp/cdoc_" .. ctype, "w")
if not outfile then
  shell.error("cdoc", "failed opening output file: " .. err)
  return shell.codes.failure
end

local types = {
  string = "\27[91mstring\27[39m",
  number = "\27[93mnumber\27[39m",
  table  = "\27[92mtable\27[39m",
  ["function"] = "\27[94mfunction\27[39m",
  ["nil"]= "\27[95mnil\27[39m",
  ["true"]= "\27[95mtrue\27[39m",
  ["false"]= "\27[95mfalse\27[39m",
  boolean= "\27[95mboolean\27[39m",
}
local function color(str, k)
  local base = str:gsub(" %-%- ?", "\n  "):gsub("function", string.format("\27[97m%s\27[39m.\27[94m%s\27[39m", ctype, k))
  for k, v in pairs(types) do
    base = base:gsub(k, v)
  end
  return base
end

outfile:write("Auto-generated documentation: component." .. ctype .. "\n\nGenerated by cdoc. I make NO GUARANTEES as to the quality of this documentation.\n\n")
for k, v in pairs(comp) do
  if k ~= "type" and k ~= "address" and k ~= "slot" then
    if verbose then
      print("METHOD", k)
    end
    outfile:write(color(tostring(v), k) .. "\n\n")
  elseif verbose then
    print("SKIP", k)
  end
end
outfile:close()
view("/tmp/cdoc_" .. ctype)
